<div #exportContainer class="glass-card rounded-2xl p-4 lg:p-6 flex flex-col">
  <div *ngIf="estimation" class="mb-3 lg:mb-4 pb-3 lg:pb-4 border-b glass-divider shrink-0">
    <div class="flex items-center gap-2 lg:gap-3">
      <span 
        class="w-8 lg:w-10 text-sm lg:text-base font-black py-0.5 lg:py-1 rounded text-center shrink-0"
        [ngClass]="[getTShirtSize().bgColor, getTShirtSize().textColor]"
      >
        {{ getTShirtSize().size }}
      </span>
      <h2 class="text-base lg:text-lg font-bold text-glass-primary truncate flex-1 min-w-0">{{ estimation.name }}</h2>
      <span 
        class="text-xs lg:text-sm font-medium py-0.5 lg:py-1 px-2 rounded shrink-0"
        [ngClass]="[getTShirtSize().bgColor, getTShirtSize().textColor]"
      >{{ getFinalComplexityPoints() }} pts</span>
    </div>
    <p class="mt-1 text-[11px] lg:text-xs text-glass-secondary">
      {{ estimation.type === 'feature' ? '‚≠ê Feature' : 'üß© User Story' }}
    </p>
    <p *ngIf="estimation.description" class="mt-1 text-[11px] lg:text-xs text-glass-muted">{{ estimation.description }}</p>
    <p *ngIf="estimation.type === 'user-story' && getParentFeature()" class="mt-1 text-[11px] lg:text-xs text-glass-secondary">
      ‚≠ê Feature : {{ getParentFeature()?.name }}
    </p>
    <!-- Liste des User Stories rattach√©es (uniquement pour les features) -->
    <div *ngIf="estimation.type === 'feature' && getChildUserStories().length > 0" class="pt-1 border-t border-white/10">
      <div class="space-y-0.5">
        <div *ngFor="let us of getChildUserStories()" class="flex justify-between text-[11px] lg:text-xs text-glass-secondary">
          <span>üß© {{ us.name }}</span>
          <span class="text-glass-muted tabular-nums">{{ calculatePointsForEstimation(us) }} pts</span>
        </div>
      </div>
      <!-- Total mode ticket de caisse -->
      <div class="flex justify-between mt-1 pt-1 border-t border-dashed border-white/20 text-[11px] lg:text-xs font-semibold text-glass-primary">
        <span>Total US</span>
        <span class="tabular-nums">{{ getChildUserStoriesTotal() }} pts</span>
      </div>
    </div>
  </div>

  <!-- D√©tail des 5 dimensions CURSE - Compact -->
  <div *ngIf="estimation" class="grid grid-cols-5 gap-1 lg:gap-1.5 mb-2 shrink-0">
    <!-- Complexity -->
    <div class="p-2 flex flex-col items-center">
      <div class="flex flex-col items-center gap-1">
        <span class="w-7 h-7 flex items-center justify-center rounded-full bg-yellow-500 text-white text-xs font-bold shrink-0">C</span>
        <div class="flex gap-1">
          <ng-container *ngFor="let grad of getGraduations('complexity'); let i = index">
            <div class="w-2 h-2 rounded-full"
                 [ngClass]="i <= getGraduationIndex('complexity') ? 'bg-yellow-500' : 'bg-gray-400'"
                 [title]="grad.label">
            </div>
          </ng-container>
        </div>
      </div>
      <div class="text-center mt-1">
        <span class="text-[10px] text-glass-muted">Complexit√©</span>
      </div>
      <div class="text-center">
        <span class="text-xs font-bold text-yellow-500 leading-tight line-clamp-1">{{ getClosestGraduationLabel('complexity') }}</span>
      </div>
    </div>

    <!-- Uncertainty -->
    <div class="p-2 flex flex-col items-center">
      <div class="flex flex-col items-center gap-1">
        <span class="w-7 h-7 flex items-center justify-center rounded-full bg-purple-500 text-white text-xs font-bold shrink-0">U</span>
        <div class="flex gap-1">
          <ng-container *ngFor="let grad of getGraduations('uncertainty'); let i = index">
            <div class="w-2 h-2 rounded-full"
                 [ngClass]="i <= getGraduationIndex('uncertainty') ? 'bg-purple-500' : 'bg-gray-400'"
                 [title]="grad.label">
            </div>
          </ng-container>
        </div>
      </div>
      <div class="text-center mt-1">
        <span class="text-[10px] text-glass-muted">Incertitude</span>
      </div>
      <div class="text-center">
        <span class="text-xs font-bold text-purple-500 leading-tight line-clamp-1">{{ getClosestGraduationLabel('uncertainty') }}</span>
      </div>
    </div>

    <!-- Risk -->
    <div class="p-2 flex flex-col items-center">
      <div class="flex flex-col items-center gap-1">
        <span class="w-7 h-7 flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold shrink-0">R</span>
        <div class="flex gap-1">
          <ng-container *ngFor="let grad of getGraduations('risk'); let i = index">
            <div class="w-2 h-2 rounded-full"
                 [ngClass]="i <= getGraduationIndex('risk') ? 'bg-red-500' : 'bg-gray-400'"
                 [title]="grad.label">
            </div>
          </ng-container>
        </div>
      </div>
      <div class="text-center mt-1">
        <span class="text-[10px] text-glass-muted">Risque</span>
      </div>
      <div class="text-center">
        <span class="text-xs font-bold text-red-500 leading-tight line-clamp-1">{{ getClosestGraduationLabel('risk') }}</span>
      </div>
    </div>

    <!-- Size -->
    <div class="p-2 flex flex-col items-center">
      <div class="flex flex-col items-center gap-1">
        <span class="w-7 h-7 flex items-center justify-center rounded-full bg-green-500 text-white text-xs font-bold shrink-0">S</span>
        <div class="flex gap-1">
          <ng-container *ngFor="let grad of getGraduations('size'); let i = index">
            <div class="w-2 h-2 rounded-full"
                 [ngClass]="i <= getGraduationIndex('size') ? 'bg-green-500' : 'bg-gray-400'"
                 [title]="grad.label">
            </div>
          </ng-container>
        </div>
      </div>
      <div class="text-center mt-1">
        <span class="text-[10px] text-glass-muted">Taille</span>
      </div>
      <div class="text-center">
        <span class="text-xs font-bold text-green-500 leading-tight line-clamp-1">{{ getClosestGraduationLabel('size') }}</span>
      </div>
    </div>

    <!-- Effort -->
    <div class="p-2 flex flex-col items-center">
      <div class="flex flex-col items-center gap-1">
        <span class="w-7 h-7 flex items-center justify-center rounded-full bg-blue-500 text-white text-xs font-bold shrink-0">E</span>
        <div class="flex gap-1">
          <ng-container *ngFor="let grad of getGraduations('effort'); let i = index">
            <div class="w-2 h-2 rounded-full"
                 [ngClass]="i <= getGraduationIndex('effort') ? 'bg-blue-500' : 'bg-gray-400'"
                 [title]="grad.label">
            </div>
          </ng-container>
        </div>
      </div>
      <div class="text-center mt-1">
        <span class="text-[10px] text-glass-muted">Effort</span>
      </div>
      <div class="text-center">
        <span class="text-xs font-bold text-blue-500 leading-tight line-clamp-1">{{ getClosestGraduationLabel('effort') }}</span>
      </div>
    </div>
  </div>

  <div class="relative flex items-center justify-center -my-10" [style.max-height]="estimation?.type === 'feature' ? '320px' : '400px'">
    <canvas #chartCanvas></canvas>
  </div>
  <!-- Message indicatif pour le mode "Somme des US" -->
  <p *ngIf="isFeatureSumUsMode() && getChildUserStories().length > 0" class="text-[10px] lg:text-[11px] text-glass-muted text-center mt-2">
    üí° Le radar refl√®te les niveaux de complexit√© les plus √©lev√©s identifi√©s dans les User Stories.
  </p>
  <!-- Auteur sous le graphique -->
  <p *ngIf="estimation?.author" class="text-[11px] lg:text-xs text-glass-muted text-right mt-2">
    <span class="opacity-70">Estimation par</span> {{ estimation?.author }}
  </p>
  <div *ngIf="!estimation" class="text-center text-glass-muted py-8">
    Aucune estimation s√©lectionn√©e. Utilisez le formulaire √† droite pour cr√©er ou modifier une estimation et voir le diagramme radar se mettre √† jour en temps r√©el.
  </div>
</div>

<!-- Boutons d'export et modification -->
<div *ngIf="estimation" class="flex items-center justify-between mt-4">
  <!-- Boutons d'export √† gauche -->
  <div class="flex items-center gap-2">
    <button 
      (click)="exportAsJpg()"
      [disabled]="isExporting"
      class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg glass-inner hover:bg-white/10 text-glass-secondary hover:text-glass-primary transition-all disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <svg *ngIf="!isExporting" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
      </svg>
      <svg *ngIf="isExporting" class="w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      JPG
    </button>
    
    <button 
      (click)="copyToClipboard()"
      [disabled]="isExporting"
      class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg glass-inner hover:bg-white/10 text-glass-secondary hover:text-glass-primary transition-all disabled:opacity-50 disabled:cursor-not-allowed"
      [ngClass]="{'bg-green-500/20': copySuccess, 'text-green-400': copySuccess}"
    >
      <svg *ngIf="!isExporting && !copySuccess" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <svg *ngIf="copySuccess" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <svg *ngIf="isExporting && !copySuccess" class="w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      {{ copySuccess ? 'Copi√© !' : 'Copier' }}
    </button>
  </div>

  <!-- Boutons √† droite -->
  <div class="flex items-center gap-2">
    <!-- Bouton D√©tails (quand pas en mode √©dition) -->
    <button 
      *ngIf="showEditButton && !isEditing"
      (click)="editEstimation.emit()"
      class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg glass-inner hover:bg-white/10 text-glass-secondary hover:text-glass-primary transition-all"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <span class="hidden sm:inline">D√©tails</span>
    </button>

    <!-- Bouton Fermer les d√©tails (en mode √©dition) -->
    <button 
      *ngIf="isEditing"
      (click)="closeEdit.emit()"
      class="flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg glass-inner hover:bg-white/10 text-glass-secondary hover:text-glass-primary transition-all"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
      <span class="hidden sm:inline">Fermer</span>
    </button>
  </div>
</div>
